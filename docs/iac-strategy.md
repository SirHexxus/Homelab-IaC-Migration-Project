# ðŸ¤– Infrastructure as Code (IaC) Strategy and Requirements

This document defines the strategy for implementing Infrastructure as Code (IaC) within the homelab migration project. It establishes the roles and responsibilities for each tool and sets the security and DevOps best practices that must be followed.

## ðŸ› ï¸ 1. Tooling Requirements and Responsibilities

The IaC implementation will primarily utilize a **declarative (Terraform)** and **imperative (Ansible)** split, orchestrated by **shell/Python scripts**, and managed entirely through **Git/GitHub**.

| Tool | Primary Role (What) | Specific Requirements (How) |
| :--- | :--- | :--- |
| **Terraform** | **Provisioning/Lifecycle Management (L1)**: Declaratively define and create the base infrastructure. | Must use the **Proxmox Provider** for resource creation (VMs, LXC containers, Cloud-Init templates, network resources). Must manage the Proxmox **API Token** securely. The state file (`terraform.tfstate`) must be secured and centrally managed (e.g., using a local backend with encryption, or a self-hosted remote backend). |
| **Ansible** | **Configuration Management (L2)**: Configure the operating systems and deploy applications *inside* the provisioned infrastructure. | Must use **Idempotent** playbooks. Configuration must rely on **Ansible Roles** for reusability. Must use **Ansible Vault** to encrypt all sensitive data (passwords, API keys, secrets). Dynamic inventory should be prioritized where possible, leveraging Proxmox metadata or simple host lists generated by Terraform output. |
| **Bash/Python** | **Orchestration/Wrapper Scripts (L3)**: Tie Terraform and Ansible together into repeatable workflows. | Python scripts (`src/scripts/`) will manage the overall deployment workflow (e.g., Run Terraform -> Wait for provisioned host -> Update Ansible Inventory -> Run Ansible). Bash will be used for simple, non-sensitive tasks like cleanup or status checks. |
| **Git/GitHub** | **Version Control & Collaboration**: Source of truth for all IaC definitions. | The main branch (`main` or `master`) must be protected. All changes require a Pull Request (PR) and at least one peer review (if collaborating, or a self-review/checklist in this portfolio project). Changes should be deployed via CI/CD (manual execution initially, with a goal for automated validation). |
| **Proxmox VE** | **Compute Platform**: Host the VMs and Containers. | Must be configured to use **Cloud-Init** for initial configuration (SSH key injection, user creation) to bridge the Terraform and Ansible stages. |
| **TrueNAS Scale** | **Storage Platform**: Provide network file shares. | Configuration (ZFS datasets, shares) should be documented and potentially managed via an API tool (if available/practical) or Ansible where necessary to ensure consistency. |

---

## ðŸ”’ 2. Security and Identity Management Requirements

All IaC processes and resulting infrastructure must adhere to the following security best practices:

* **Principle of Least Privilege:** All automation users (e.g., the Proxmox API user used by Terraform) must have the minimum permissions required to perform their specific task.
* **Secrets Management:** All sensitive credentials, including API keys, passwords, and private keys, **must not** be stored in plaintext within the repository. **Ansible Vault** is the required tool for managing secrets used in configuration.
* **Infrastructure Segregation:** The network design must enforce strict segmentation using **VLANs** (e.g., Management, Servers, General LAN, IoT) to limit the blast radius of any security incident.
* **Key-Based Authentication:** Password-based authentication for administrative tasks (SSH) on all provisioned Linux systems is **prohibited**. Only SSH key-based authentication must be used, injected via Cloud-Init and managed by Ansible.

---

## ðŸ“ˆ 3. DevOps and Reproducibility Requirements

The overarching goal is to demonstrate a mature, repeatable DevOps workflow.

* **Idempotency:** All Ansible playbooks must be **idempotent**, meaning running the playbook multiple times results in the same system state without errors or unnecessary changes.
* **Reproducibility:** The entire stack, from network configuration to application deployment, must be fully reproducible. Any component can be destroyed and redeployed using the IaC code and achieve the identical configuration (barring initial provisioning IDs).
* **Modularity:** Terraform configurations must be broken into **modules** (`src/terraform/modules/`) for reusable infrastructure components (e.g., an "Ubuntu-VM" module). Ansible code must use **roles** (`src/ansible/roles/`) for reusable tasks (e.g., a "common" role for OS hardening).
* **Pipeline Focus:** The project documentation must outline a clear, three-stage pipeline: **Provisioning (Terraform) -> Configuration (Ansible) -> Deployment (Ansible/Scripts).**
